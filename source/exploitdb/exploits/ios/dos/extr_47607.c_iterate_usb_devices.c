#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  scalar_t__ kern_return_t ;
typedef  int /*<<< orphan*/  io_service_t ;
typedef  int /*<<< orphan*/  io_iterator_t ;
typedef  int /*<<< orphan*/  IOUSBDeviceInterface ;
typedef  int /*<<< orphan*/ * CFMutableDictionaryRef ;

/* Variables and functions */
 int /*<<< orphan*/  IOIteratorNext (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  IOObjectRelease (int /*<<< orphan*/ ) ; 
 scalar_t__ IOServiceGetMatchingServices (int /*<<< orphan*/ ,int /*<<< orphan*/ *,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/ * IOServiceMatching (int /*<<< orphan*/ ) ; 
 scalar_t__ KERN_SUCCESS ; 
 scalar_t__ get_usbdevice_handle (int /*<<< orphan*/ ,int /*<<< orphan*/ ***) ; 
 int /*<<< orphan*/  kIOMasterPortDefault ; 
 int /*<<< orphan*/  kIOUSBDeviceClassName ; 
 char* mach_error_string (scalar_t__) ; 
 scalar_t__ print_usb_device (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 scalar_t__ send_usbusted_pwn_msg (int /*<<< orphan*/ **,char const*) ; 

__attribute__((used)) static int iterate_usb_devices(const char *msg){
    CFMutableDictionaryRef matchingDict;
    io_iterator_t iter;
    kern_return_t kr;
    io_service_t device;

    /* set up a matching dictionary for the class */
    matchingDict = IOServiceMatching(kIOUSBDeviceClassName);
    if (matchingDict == NULL)
    {
        return -1; // fail
    }
    
    /* Now we have a dictionary, get an iterator.*/
    kr = IOServiceGetMatchingServices(kIOMasterPortDefault, matchingDict, &iter);
    if (kr != KERN_SUCCESS)
    {
        return -1;
    }

    /* iterate */
    while ((device = IOIteratorNext(iter)))
    {
        /* do something with device, eg. check properties */
        kr = print_usb_device(device);
        
        if(kr != KERN_SUCCESS){
            printf("Skipping device as it has no vid / pid.\n");
            continue;
        }
        
        IOUSBDeviceInterface **dev = 0;
        kr = get_usbdevice_handle(device, &dev);
        
        if(kr != KERN_SUCCESS){
            printf("Skipping device as no handle for it could be retrieved.\n");
            continue;
        }
        
        kr = send_usbusted_pwn_msg(dev, msg);
        printf("RET: %s\n\n", mach_error_string(kr));
        
        /* And free the reference taken before continuing to the next item */
        IOObjectRelease(device);
    }

   /* Done, release the iterator */
   IOObjectRelease(iter);
   return 0;
}