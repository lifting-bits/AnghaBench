#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_2__   TYPE_1__ ;

/* Type definitions */
struct pud_entry {int addr; struct pmd_entry** entries; } ;
struct pgd_entry {int addr; struct pud_entry** entries; } ;
struct ptsc {unsigned long physmap; struct pgd_entry entry; } ;
struct pte_entry {int addr; unsigned long* entries; } ;
struct pmd_entry {int addr; TYPE_1__* entries; } ;
struct TYPE_2__ {unsigned long phys; int huge; struct pte_entry* pte; } ;

/* Variables and functions */
 unsigned long HUGE_PAGE_MASK ; 
 unsigned long PAGE_MASK ; 
 unsigned long PHYSICAL_PAGE_MASK ; 
 int _PAGE_PSE ; 
 int /*<<< orphan*/  debug1 (char*,...) ; 
 int pgd_index (unsigned long) ; 
 scalar_t__ pgd_none (unsigned long) ; 
 int /*<<< orphan*/  pgd_present (unsigned long) ; 
 int pmd_flags (unsigned long) ; 
 int pmd_index (unsigned long) ; 
 scalar_t__ pmd_none (unsigned long) ; 
 int /*<<< orphan*/  pmd_present (unsigned long) ; 
 int pte_index (unsigned long) ; 
 scalar_t__ pte_none (unsigned long) ; 
 int /*<<< orphan*/  pte_present (unsigned long) ; 
 struct pmd_entry* ptsc_alloc_pmd_entry (unsigned long) ; 
 struct pte_entry* ptsc_alloc_pte_entry (unsigned long) ; 
 struct pud_entry* ptsc_alloc_pud_entry (unsigned long) ; 
 int pud_index (unsigned long) ; 
 scalar_t__ pud_none (unsigned long) ; 
 int /*<<< orphan*/  pud_present (unsigned long) ; 
 unsigned long read_8 (int) ; 

__attribute__((used)) static unsigned long ptsc_page_virt_to_phys(struct ptsc* ptsc,
						unsigned long addr) {
	struct pgd_entry *pgd_e;
	struct pud_entry *pud_e;
	struct pmd_entry *pmd_e;
	struct pte_entry *pte_e;
	unsigned long phys_a;
	int index;

	debug1("looking up phys addr for %016lx:\n", addr);

	pgd_e = &ptsc->entry;

	index = pgd_index(addr);
	debug1(" pgd: %016lx, index: %d\n", pgd_e->addr, index);
	if (!pgd_e->entries[index]) {
		unsigned long pgd_v = read_8(
			pgd_e->addr + index * sizeof(unsigned long));
		debug1("   -> %016lx\n", pgd_v);
		if (pgd_none(pgd_v)) {
			debug1(" not found, pgd is none\n");
			return 0;
		}
		if (!pgd_present(pgd_v)) {
			debug1(" not found, pgd is not present\n");
			return 0;
		}
		unsigned long pud_a =
			ptsc->physmap + (pgd_v & PHYSICAL_PAGE_MASK);
		pud_e = ptsc_alloc_pud_entry(pud_a);
		pgd_e->entries[index] = pud_e;
	}
	pud_e = pgd_e->entries[index];

	index = pud_index(addr);
	debug1(" pud: %016lx, index: %d\n", pud_e->addr, index);
	if (!pud_e->entries[index]) {
		unsigned long pud_v = read_8(
			pud_e->addr + index * sizeof(unsigned long));
		debug1("   -> %016lx\n", pud_v);
		if (pud_none(pud_v)) {
			debug1(" not found, pud is none\n");
			return 0;
		}
		if (!pud_present(pud_v)) {
			debug1(" not found, pud is not present\n");
			return 0;
		}
		unsigned long pmd_a =
			ptsc->physmap + (pud_v & PHYSICAL_PAGE_MASK);
		pmd_e = ptsc_alloc_pmd_entry(pmd_a);
		pud_e->entries[index] = pmd_e;
	}
	pmd_e = pud_e->entries[index];

	index = pmd_index(addr);
	debug1(" pmd: %016lx, index: %d\n", pmd_e->addr, index);
	if (!pmd_e->entries[index].pte) {
		unsigned long pmd_v = read_8(
			pmd_e->addr + index * sizeof(unsigned long));
		debug1("   -> %016lx\n", pmd_v);
		if (pmd_none(pmd_v)) {
			debug1(" not found, pmd is none\n");
			return 0;
		}
		if (!pmd_present(pmd_v)) {
			debug1(" not found, pmd is not present\n");
			return 0;
		}
		if (pmd_flags(pmd_v) & _PAGE_PSE) {
			phys_a = ptsc->physmap + (pmd_v & PHYSICAL_PAGE_MASK) +
					(addr & ~HUGE_PAGE_MASK);
			pmd_e->entries[index].phys = phys_a;
			pmd_e->entries[index].huge = true;
		} else {
			unsigned long pte_a =
				ptsc->physmap + (pmd_v & PHYSICAL_PAGE_MASK);
			pte_e = ptsc_alloc_pte_entry(pte_a);
			pmd_e->entries[index].pte = pte_e;
			pmd_e->entries[index].huge = false;
		}
	}

	if (pmd_e->entries[index].huge) {
		debug1(" phy: %016lx (huge)\n", phys_a);
		return pmd_e->entries[index].phys;
	}

	pte_e = pmd_e->entries[index].pte;

	index = pte_index(addr);
	debug1(" pte: %016lx, index: %d\n", pte_e->addr, index);
	if (!pte_e->entries[index]) {
		unsigned long pte_v = read_8(
			pte_e->addr + index * sizeof(unsigned long));
		debug1("   -> %016lx\n", pte_v);
		if (pte_none(pte_v)) {
			debug1(" not found, pte is none\n");
			return 0;
		}
		if (!pte_present(pte_v)) {
			debug1(" not found, pte is not present\n");
			return 0;
		}
		phys_a = ptsc->physmap + (pte_v & PHYSICAL_PAGE_MASK) +
				(addr & ~PAGE_MASK);
		pte_e->entries[index] = phys_a;
	}
	phys_a = pte_e->entries[index];

	return phys_a;
}